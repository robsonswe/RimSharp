<dialogs:BaseDialog x:Class="RimSharp.Features.ModManager.Dialogs.MissingMods.MissingModSelectionDialogView"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:dialogs="clr-namespace:RimSharp.Infrastructure.Dialog"
        xmlns:vm="clr-namespace:RimSharp.Features.ModManager.Dialogs.MissingMods"
        mc:Ignorable="d"
        d:DataContext="{d:DesignInstance Type=vm:MissingModSelectionDialogViewModel, IsDesignTimeCreatable=False}"
        Title="{Binding Title}"
        Width="750" MinWidth="600" MaxWidth="900"
        Height="550" MinHeight="400" MaxHeight="700"
        WindowStartupLocation="CenterOwner"
        ShowInTaskbar="False"
        ResizeMode="CanResizeWithGrip">

    <dialogs:BaseDialog.Resources>
        <!-- DataTemplate for a single Mod Variant (RadioButton and details) -->
        <DataTemplate x:Key="ModVariantTemplate" DataType="{x:Type vm:MissingModVariantViewModel}">
            <!-- Make the Grid non-focusable -->
            <Grid Margin="0,2" Focusable="False">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/> <!-- Radio Button -->
                    <ColumnDefinition Width="*"/> <!-- Details -->
                </Grid.ColumnDefinitions>

                 <!-- RadioButton should be the main focus target within the item -->
                <RadioButton Grid.Column="0" VerticalAlignment="Center" Margin="0,0,8,0"
                            GroupName="{Binding DataContext.PackageId, RelativeSource={RelativeSource AncestorType={x:Type ItemsControl}}}"
                            IsChecked="{Binding IsSelected, RelativeSource={RelativeSource AncestorType={x:Type ListBoxItem}}}"/>

                 <!-- Make the Border non-focusable -->
                <Border Grid.Column="1" Style="{StaticResource RimworldSubtlePanelBorder}" Padding="8,5" Focusable="False">
                     <!-- Make the StackPanel non-focusable -->
                     <StackPanel Orientation="Vertical" Focusable="False">
                        <!-- TextBlocks are generally not focusable by default, which is fine -->
                        <TextBlock FontWeight="SemiBold" Text="{Binding Name}" Foreground="{StaticResource RimworldDarkBrownBrush}" TextWrapping="Wrap"/>
                        <TextBlock FontSize="11" Margin="0,2,0,0" Foreground="{StaticResource RimworldDarkBrownBrush}">
                            <Run Text="Author(s):"/> <Run Text="{Binding Authors}"/>
                        </TextBlock>
                        <TextBlock FontSize="11" Margin="0,1,0,0" Foreground="{StaticResource RimworldDarkBrownBrush}">
                            <Run Text="Supported Versions:"/> <Run Text="{Binding VersionsString}"/>
                        </TextBlock>
                        <TextBlock FontSize="11" FontStyle="Italic" Margin="0,1,0,0" Foreground="{StaticResource RimworldDarkBrownBrush}">
                            <Run Text="Steam ID:"/> <Run Text="{Binding SteamId, Mode=OneWay}"/>
                        </TextBlock>
                    </StackPanel>
                </Border>
            </Grid>
        </DataTemplate>

         <!-- DataTemplate for a Group of Mod Variants (Expander with ListBox) -->
        <DataTemplate x:Key="ModGroupTemplate" DataType="{x:Type vm:MissingModGroupViewModel}">
            <Expander Header="{Binding PackageId}" IsExpanded="True" Margin="0,5,0,5" Style="{StaticResource RimworldExpanderStyle}">
                <ListBox ItemsSource="{Binding Variants}"
                        ItemTemplate="{StaticResource ModVariantTemplate}"
                        SelectedItem="{Binding SelectedVariant, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                        BorderThickness="0" Background="Transparent"
                        ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                    <ListBox.ItemContainerStyle>
                         <!-- Style already has Focusable="False", which is correct -->
                        <Style TargetType="ListBoxItem" BasedOn="{StaticResource {x:Type ListBoxItem}}">
                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                            <Setter Property="Padding" Value="0"/>
                            <Setter Property="Margin" Value="1"/>
                            <Setter Property="Focusable" Value="False"/>
                        </Style>
                    </ListBox.ItemContainerStyle>
                </ListBox>
            </Expander>
        </DataTemplate>
    </dialogs:BaseDialog.Resources>

    <!-- Define Main Content -->
    <dialogs:BaseDialog.MainContent>
        <Grid Margin="10">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/> <!-- Header Text -->
                <RowDefinition Height="*"/> <!-- Known Mods ScrollViewer -->
                <RowDefinition Height="Auto"/> <!-- Unknown Mods Separator/Header -->
                <RowDefinition Height="Auto"/> <!-- Unknown Mods List -->
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" TextWrapping="Wrap" Margin="0,0,0,10" Foreground="{StaticResource RimworldDarkBrownBrush}">
                The following mods from the imported list were not found locally. If multiple versions exist in the database, please select the one you wish to download.
            </TextBlock>

            <!-- Scrollable List for Known Mod Groups -->
            <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled"
                          Visibility="{Binding HasKnownMods, Converter={StaticResource BooleanToVisibilityConverter}}">
                <ItemsControl ItemsSource="{Binding ModGroups}"
                            ItemTemplate="{StaticResource ModGroupTemplate}"/>
            </ScrollViewer>

            <!-- Separator and Header for Unknown Mods -->
             <StackPanel Grid.Row="2" Margin="0,15,0,5"
                        Visibility="{Binding HasUnknownMods, Converter={StaticResource BooleanToVisibilityConverter}}">
                <Separator Style="{StaticResource RimworldSeparatorStyle}"/>
                <TextBlock Text="Unknown Mods (Not found in database):" FontWeight="SemiBold" Margin="0,8,0,5" Foreground="{StaticResource RimworldDarkBrownBrush}"/>
                <TextBlock TextWrapping="Wrap" FontSize="11" Foreground="{StaticResource RimworldLightBrownBrush}">
                    These mods could not be matched to a Steam ID in the local database. They cannot be downloaded automatically.
                </TextBlock>
             </StackPanel>

            <!-- List for Unknown Mod IDs -->
            <ListBox Grid.Row="3" ItemsSource="{Binding UnknownModIds}" Margin="0,0,0,5" MaxHeight="100"
                    BorderBrush="{StaticResource RimworldBorderBrush}" BorderThickness="1" Background="{StaticResource RimworldLightBackgroundBrush}"
                    ScrollViewer.VerticalScrollBarVisibility="Auto"
                    Visibility="{Binding HasUnknownMods, Converter={StaticResource BooleanToVisibilityConverter}}">
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <TextBlock Text="{Binding}" Margin="5,2" Foreground="{StaticResource RimworldDarkBrownBrush}"/>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>

        </Grid>
    </dialogs:BaseDialog.MainContent>

    <!-- Define Button Content -->
    <dialogs:BaseDialog.ButtonContent>
        <Grid Margin="0,12,0,5">
             <!-- Make sure Button Styles exist -->
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                <!-- Download Button -->
                <Button Content="Download Selected"
                        Command="{Binding DownloadCommand}"
                        Style="{StaticResource RimworldSaveButtonStyle}"
                        MinWidth="120"
                        Height="30"
                        Margin="5,0,5,0"/>

                <!-- Cancel Button -->
                <Button Content="Cancel"
                        Command="{Binding CancelCommand}"
                        Style="{StaticResource RimworldRunButtonStyle}"
                        IsCancel="True"
                        MinWidth="80"
                        Height="30"
                        Margin="5,0,0,0"/>
            </StackPanel>
        </Grid>
    </dialogs:BaseDialog.ButtonContent>

</dialogs:BaseDialog>