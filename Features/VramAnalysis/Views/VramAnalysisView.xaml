<!-- Features/VramAnalysis/Views/VramAnalysisView.xaml -->
<UserControl x:Class="RimSharp.Features.VramAnalysis.Views.VramAnalysisView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:vm="clr-namespace:RimSharp.Features.VramAnalysis.ViewModels"
             xmlns:tools="clr-namespace:RimSharp.Features.VramAnalysis.Tools"
             mc:Ignorable="d" 
             d:DataContext="{d:DesignInstance Type=vm:VramAnalysisViewModel}"
             d:DesignHeight="600" d:DesignWidth="800">
    <DockPanel>
        <!-- Top Control Bar with VRAM Totals -->
        <Border DockPanel.Dock="Top" Padding="5" Background="{StaticResource RimworldLightBackgroundBrush}" Margin="0,0,0,5">
            <Grid>
                <Grid.ColumnDefinitions><ColumnDefinition Width="Auto"/><ColumnDefinition Width="*"/></Grid.ColumnDefinitions>
                <Button Grid.Column="0" Content="Calculate VRAM" Command="{Binding CalculateVramCommand}" Style="{StaticResource RimworldButtonStyle}" ToolTip="Starts the process of analyzing texture files to estimate VRAM usage."/>
                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                    <!-- Default/Current View -->
                    <StackPanel Orientation="Horizontal" Visibility="{Binding ShowMaxVram, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
                        <TextBlock Text="Active Textures (Atlas/Total): " FontWeight="SemiBold" VerticalAlignment="Center" Foreground="{StaticResource RimworldBrownBrush}"/>
                        <TextBlock Text="{Binding TotalInAtlasCountActiveMods, StringFormat=N0}" VerticalAlignment="Center" Foreground="{StaticResource RimworldBrownBrush}" ToolTip="Textures small enough to be atlased"/>
                        <TextBlock Text="/" VerticalAlignment="Center" Foreground="{StaticResource RimworldSubtleTextBrush}" Margin="2,0"/>
                        <TextBlock Text="{Binding TotalTextureCountActiveMods, StringFormat=N0}" VerticalAlignment="Center" Foreground="{StaticResource RimworldBrownBrush}" Margin="0,0,15,0" ToolTip="Total textures"/>
                        <TextBlock Text="Active VRAM: " FontWeight="SemiBold" VerticalAlignment="Center" Foreground="{StaticResource RimworldBrownBrush}"/>
                        <TextBlock Text="{Binding TotalVramCompressedActiveMods, Converter={StaticResource FileSizeConverter}}" VerticalAlignment="Center" Foreground="{StaticResource RimworldBrownBrush}" Margin="0,0,20,0"/>
                        <TextBlock Text="Favorites VRAM: " FontWeight="SemiBold" VerticalAlignment="Center" Foreground="{StaticResource RimworldBrownBrush}"/>
                        <TextBlock Text="{Binding TotalVramCompressedFavoriteMods, Converter={StaticResource FileSizeConverter}}" VerticalAlignment="Center" Foreground="{StaticResource RimworldBrownBrush}" Margin="0,0,20,0"/>
                    </StackPanel>
                    <!-- Max View -->
                    <StackPanel Orientation="Horizontal" Visibility="{Binding ShowMaxVram, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <TextBlock Text="Active Textures (Atlas/Total): " FontWeight="SemiBold" VerticalAlignment="Center" Foreground="{StaticResource RimworldBrownBrush}"/>
                        <TextBlock Text="{Binding MaxTotalInAtlasCountActiveMods, StringFormat=N0}" VerticalAlignment="Center" Foreground="{StaticResource RimworldBrownBrush}" ToolTip="Max textures small enough to be atlased"/>
                        <TextBlock Text="/" VerticalAlignment="Center" Foreground="{StaticResource RimworldSubtleTextBrush}" Margin="2,0"/>
                        <TextBlock Text="{Binding MaxTotalTextureCountActiveMods, StringFormat=N0}" VerticalAlignment="Center" Foreground="{StaticResource RimworldBrownBrush}" Margin="0,0,15,0" ToolTip="Max total textures"/>
                        <TextBlock Text="Active VRAM: " FontWeight="SemiBold" VerticalAlignment="Center" Foreground="{StaticResource RimworldBrownBrush}"/>
                        <TextBlock Text="{Binding MaxTotalVramCompressedActiveMods, Converter={StaticResource FileSizeConverter}}" VerticalAlignment="Center" Foreground="{StaticResource RimworldBrownBrush}" Margin="0,0,20,0"/>
                        <TextBlock Text="Favorites VRAM: " FontWeight="SemiBold" VerticalAlignment="Center" Foreground="{StaticResource RimworldBrownBrush}"/>
                        <TextBlock Text="{Binding MaxTotalVramCompressedFavoriteMods, Converter={StaticResource FileSizeConverter}}" VerticalAlignment="Center" Foreground="{StaticResource RimworldBrownBrush}" Margin="0,0,20,0"/>
                    </StackPanel>
                    <!-- User VRAM (Always Visible) -->
                    <StackPanel Orientation="Horizontal" Visibility="{Binding IsUserVramAvailable, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <TextBlock Text="User VRAM: " FontWeight="SemiBold" VerticalAlignment="Center" Foreground="{StaticResource RimworldBrownBrush}"/>
                        <TextBlock Text="{Binding UserVram, Converter={StaticResource FileSizeConverter}}" VerticalAlignment="Center" Foreground="{StaticResource RimworldBrownBrush}"/>
                    </StackPanel>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Filter Bar -->
        <Border DockPanel.Dock="Top" Padding="5" Background="{StaticResource RimworldLightBackgroundBrush}" Margin="0,0,0,5">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Left">
                <CheckBox Content="Show only active mods" IsChecked="{Binding ShowOnlyActive, Mode=TwoWay}" Foreground="{StaticResource RimworldBrownBrush}" VerticalAlignment="Center" Margin="0,0,20,0"/>
                <CheckBox Content="Show only favorite mods" IsChecked="{Binding ShowOnlyFavorites, Mode=TwoWay}" Foreground="{StaticResource RimworldBrownBrush}" VerticalAlignment="Center" Margin="0,0,20,0"/>
                <CheckBox Content="Show Max VRAM" IsChecked="{Binding ShowMaxVram, Mode=TwoWay}" Foreground="{StaticResource RimworldBrownBrush}" VerticalAlignment="Center" ToolTip="When checked, shows the maximum possible VRAM usage and texture counts for all mods, ignoring conditional loading."/>
            </StackPanel>
        </Border>

        <!-- Main Content Grid -->
        <Grid>
            <Border Background="#44000000" CornerRadius="3" Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}"><TextBlock Text="Calculating..." HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="20" FontWeight="Bold" Foreground="{StaticResource RimworldWhiteBrush}"/></Border>
            <Border BorderBrush="{StaticResource RimworldBrownBrush}" BorderThickness="1">
                <ListView ItemsSource="{Binding VramMods}" ScrollViewer.VerticalScrollBarVisibility="Auto" Margin="0,5,0,0">
                    <ListView.ItemContainerStyle><Style TargetType="ListViewItem"><Setter Property="HorizontalContentAlignment" Value="Stretch"/><Setter Property="Padding" Value="5"/><Setter Property="Foreground" Value="{StaticResource RimworldBrownBrush}"/><Setter Property="Background" Value="Transparent"/><Setter Property="Focusable" Value="False"/><Style.Triggers><Trigger Property="IsMouseOver" Value="True"><Setter Property="Background" Value="{StaticResource RimworldDarkBeigeBrush}"/></Trigger></Style.Triggers></Style></ListView.ItemContainerStyle>
                    <ListView.View>
                        <GridView>
                            <GridView.ColumnHeaderContainerStyle><Style TargetType="GridViewColumnHeader"><Setter Property="Background" Value="{StaticResource RimworldLightBrownBrush}"/><Setter Property="Foreground" Value="{StaticResource RimworldWhiteBrush}"/><Setter Property="Padding" Value="7,5"/><Setter Property="BorderThickness" Value="0,0,0,1"/><Setter Property="BorderBrush" Value="{StaticResource RimworldBrownBrush}"/><Setter Property="FontWeight" Value="SemiBold"/><EventSetter Event="ButtonBase.Click" Handler="GridViewColumnHeader_Click"/></Style></GridView.ColumnHeaderContainerStyle>
                            <GridViewColumn Width="300"><GridViewColumn.Header><DockPanel><TextBlock Text="Mod Name" Tag="Mod.Name"/><TextBlock Margin="5,0,0,0" Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=GridViewColumnHeader}}"><TextBlock.Style><Style TargetType="TextBlock"><Setter Property="Text" Value=""/><Style.Triggers><MultiDataTrigger><MultiDataTrigger.Conditions><Condition Binding="{Binding DataContext.CurrentSortColumn, RelativeSource={RelativeSource AncestorType=ListView}}" Value="Mod.Name"/><Condition Binding="{Binding DataContext.SortDirection, RelativeSource={RelativeSource AncestorType=ListView}}" Value="Ascending"/></MultiDataTrigger.Conditions><Setter Property="Text" Value="▲"/></MultiDataTrigger><MultiDataTrigger><MultiDataTrigger.Conditions><Condition Binding="{Binding DataContext.CurrentSortColumn, RelativeSource={RelativeSource AncestorType=ListView}}" Value="Mod.Name"/><Condition Binding="{Binding DataContext.SortDirection, RelativeSource={RelativeSource AncestorType=ListView}}" Value="Descending"/></MultiDataTrigger.Conditions><Setter Property="Text" Value="▼"/></MultiDataTrigger></Style.Triggers></Style></TextBlock.Style></TextBlock></DockPanel></GridViewColumn.Header><GridViewColumn.CellTemplate><DataTemplate><TextBlock Text="{Binding Mod.Name}" TextTrimming="CharacterEllipsis" ToolTip="{Binding Mod.Name}"><TextBlock.Style><Style TargetType="TextBlock"><Style.Triggers><DataTrigger Binding="{Binding Mod.IsActive}" Value="True"><Setter Property="FontWeight" Value="Bold"/></DataTrigger><DataTrigger Binding="{Binding Mod.IsFavorite}" Value="True"><Setter Property="Foreground" Value="{StaticResource RimworldCodeBlueBrush}"/></DataTrigger><DataTrigger Binding="{Binding HasConditionalContent}" Value="True"><Setter Property="FontStyle" Value="Italic"/></DataTrigger></Style.Triggers></Style></TextBlock.Style></TextBlock></DataTemplate></GridViewColumn.CellTemplate></GridViewColumn>
                            
                            <GridViewColumn Width="100">
                                <GridViewColumn.Header>
                                    <DockPanel>
                                        <TextBlock Text="Atlas" Tag="InAtlasCount">
                                            <TextBlock.ToolTip>
                                                <ToolTip Style="{StaticResource RimworldToolTip}">
                                                    <TextBlock>
                                                        A texture atlas is a performance optimization where the game combines many small textures onto a single large 'sticker sheet'.<LineBreak/><LineBreak/>
                                                        This column counts how many textures in the mod are small enough to be included in these atlases.
                                                    </TextBlock>
                                                </ToolTip>
                                            </TextBlock.ToolTip>
                                        </TextBlock>
                                        <TextBlock Margin="5,0,0,0" Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=GridViewColumnHeader}}"><TextBlock.Style><Style TargetType="TextBlock"><Setter Property="Text" Value=""/><Style.Triggers><MultiDataTrigger><MultiDataTrigger.Conditions><Condition Binding="{Binding DataContext.CurrentSortColumn, RelativeSource={RelativeSource AncestorType=ListView}}" Value="InAtlasCount"/><Condition Binding="{Binding DataContext.SortDirection, RelativeSource={RelativeSource AncestorType=ListView}}" Value="Ascending"/></MultiDataTrigger.Conditions><Setter Property="Text" Value="▲"/></MultiDataTrigger><MultiDataTrigger><MultiDataTrigger.Conditions><Condition Binding="{Binding DataContext.CurrentSortColumn, RelativeSource={RelativeSource AncestorType=ListView}}" Value="InAtlasCount"/><Condition Binding="{Binding DataContext.SortDirection, RelativeSource={RelativeSource AncestorType=ListView}}" Value="Descending"/></MultiDataTrigger.Conditions><Setter Property="Text" Value="▼"/></MultiDataTrigger></Style.Triggers></Style></TextBlock.Style></TextBlock>
                                    </DockPanel>
                                </GridViewColumn.Header>
                                <GridViewColumn.CellTemplate><DataTemplate><TextBlock HorizontalAlignment="Right"><TextBlock.Style><Style TargetType="TextBlock"><Setter Property="Text" Value="{Binding InAtlasCount, StringFormat=N0}"/><Style.Triggers><DataTrigger Binding="{Binding HasConditionalContent}" Value="True"><Setter Property="ToolTip"><Setter.Value><ToolTip Style="{StaticResource RimworldToolTip}"><StackPanel><TextBlock Text="Conditional Content:" FontWeight="Bold" Margin="0,0,0,4"/><ItemsControl ItemsSource="{Binding ConditionalDependencies}"><ItemsControl.ItemTemplate><DataTemplate DataType="{x:Type tools:ConditionalDependency}"><StackPanel Orientation="Horizontal"><TextBlock Text="{Binding IsActive, Converter={StaticResource BooleanToTextConverter}, ConverterParameter='❌|✅'}" VerticalAlignment="Center" Margin="0,0,5,0"/><TextBlock Text="{Binding PackageId}" VerticalAlignment="Center"/></StackPanel></DataTemplate></ItemsControl.ItemTemplate></ItemsControl></StackPanel></ToolTip></Setter.Value></Setter></DataTrigger><DataTrigger Binding="{Binding DataContext.ShowMaxVram, RelativeSource={RelativeSource AncestorType=ListView}}" Value="True"><Setter Property="Text" Value="{Binding MaxInAtlasCount, StringFormat=N0}"/><Setter Property="ToolTip" Value="Showing maximum possible atlased texture count."/></DataTrigger></Style.Triggers></Style></TextBlock.Style></TextBlock></DataTemplate></GridViewColumn.CellTemplate>
                            </GridViewColumn>
                            
                            <GridViewColumn Width="100"><GridViewColumn.Header><DockPanel><TextBlock Text="Textures" Tag="TextureCount"/><TextBlock Margin="5,0,0,0" Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=GridViewColumnHeader}}"><TextBlock.Style><Style TargetType="TextBlock"><Setter Property="Text" Value=""/><Style.Triggers><MultiDataTrigger><MultiDataTrigger.Conditions><Condition Binding="{Binding DataContext.CurrentSortColumn, RelativeSource={RelativeSource AncestorType=ListView}}" Value="TextureCount"/><Condition Binding="{Binding DataContext.SortDirection, RelativeSource={RelativeSource AncestorType=ListView}}" Value="Ascending"/></MultiDataTrigger.Conditions><Setter Property="Text" Value="▲"/></MultiDataTrigger><MultiDataTrigger><MultiDataTrigger.Conditions><Condition Binding="{Binding DataContext.CurrentSortColumn, RelativeSource={RelativeSource AncestorType=ListView}}" Value="TextureCount"/><Condition Binding="{Binding DataContext.SortDirection, RelativeSource={RelativeSource AncestorType=ListView}}" Value="Descending"/></MultiDataTrigger.Conditions><Setter Property="Text" Value="▼"/></MultiDataTrigger></Style.Triggers></Style></TextBlock.Style></TextBlock></DockPanel></GridViewColumn.Header><GridViewColumn.CellTemplate><DataTemplate><TextBlock HorizontalAlignment="Right"><TextBlock.Style><Style TargetType="TextBlock"><Setter Property="Text" Value="{Binding TextureCount, StringFormat=N0}"/><Style.Triggers><DataTrigger Binding="{Binding HasConditionalContent}" Value="True"><Setter Property="ToolTip"><Setter.Value><ToolTip Style="{StaticResource RimworldToolTip}"><StackPanel><TextBlock Text="Conditional Content:" FontWeight="Bold" Margin="0,0,0,4"/><ItemsControl ItemsSource="{Binding ConditionalDependencies}"><ItemsControl.ItemTemplate><DataTemplate DataType="{x:Type tools:ConditionalDependency}"><StackPanel Orientation="Horizontal"><TextBlock Text="{Binding IsActive, Converter={StaticResource BooleanToTextConverter}, ConverterParameter='❌|✅'}" VerticalAlignment="Center" Margin="0,0,5,0"/><TextBlock Text="{Binding PackageId}" VerticalAlignment="Center"/></StackPanel></DataTemplate></ItemsControl.ItemTemplate></ItemsControl></StackPanel></ToolTip></Setter.Value></Setter></DataTrigger><DataTrigger Binding="{Binding DataContext.ShowMaxVram, RelativeSource={RelativeSource AncestorType=ListView}}" Value="True"><Setter Property="Text" Value="{Binding MaxTextureCount, StringFormat=N0}"/><Setter Property="ToolTip" Value="Showing maximum possible texture count."/></DataTrigger></Style.Triggers></Style></TextBlock.Style></TextBlock></DataTemplate></GridViewColumn.CellTemplate></GridViewColumn>
                            <GridViewColumn Width="150"><GridViewColumn.Header><DockPanel><TextBlock Text="VRAM (Compressed)" Tag="EstimatedVramCompressed"/><TextBlock Margin="5,0,0,0" Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=GridViewColumnHeader}}"><TextBlock.Style><Style TargetType="TextBlock"><Setter Property="Text" Value=""/><Style.Triggers><MultiDataTrigger><MultiDataTrigger.Conditions><Condition Binding="{Binding DataContext.CurrentSortColumn, RelativeSource={RelativeSource AncestorType=ListView}}" Value="EstimatedVramCompressed"/><Condition Binding="{Binding DataContext.SortDirection, RelativeSource={RelativeSource AncestorType=ListView}}" Value="Ascending"/></MultiDataTrigger.Conditions><Setter Property="Text" Value="▲"/></MultiDataTrigger><MultiDataTrigger><MultiDataTrigger.Conditions><Condition Binding="{Binding DataContext.CurrentSortColumn, RelativeSource={RelativeSource AncestorType=ListView}}" Value="EstimatedVramCompressed"/><Condition Binding="{Binding DataContext.SortDirection, RelativeSource={RelativeSource AncestorType=ListView}}" Value="Descending"/></MultiDataTrigger.Conditions><Setter Property="Text" Value="▼"/></MultiDataTrigger></Style.Triggers></Style></TextBlock.Style></TextBlock></DockPanel></GridViewColumn.Header><GridViewColumn.CellTemplate><DataTemplate><TextBlock HorizontalAlignment="Right"><TextBlock.Style><Style TargetType="TextBlock"><Setter Property="Text" Value="{Binding EstimatedVramCompressed, Converter={StaticResource FileSizeConverter}}"/><Style.Triggers><DataTrigger Binding="{Binding HasConditionalContent}" Value="True"><Setter Property="ToolTip"><Setter.Value><ToolTip Style="{StaticResource RimworldToolTip}"><StackPanel><TextBlock Text="Conditional Content:" FontWeight="Bold" Margin="0,0,0,4"/><ItemsControl ItemsSource="{Binding ConditionalDependencies}"><ItemsControl.ItemTemplate><DataTemplate DataType="{x:Type tools:ConditionalDependency}"><StackPanel Orientation="Horizontal"><TextBlock Text="{Binding IsActive, Converter={StaticResource BooleanToTextConverter}, ConverterParameter='❌|✅'}" VerticalAlignment="Center" Margin="0,0,5,0"/><TextBlock Text="{Binding PackageId}" VerticalAlignment="Center"/></StackPanel></DataTemplate></ItemsControl.ItemTemplate></ItemsControl></StackPanel></ToolTip></Setter.Value></Setter></DataTrigger><DataTrigger Binding="{Binding DataContext.ShowMaxVram, RelativeSource={RelativeSource AncestorType=ListView}}" Value="True"><Setter Property="Text" Value="{Binding MaxEstimatedVramCompressed, Converter={StaticResource FileSizeConverter}}"/><Setter Property="ToolTip" Value="Showing maximum possible usage."/></DataTrigger></Style.Triggers></Style></TextBlock.Style></TextBlock></DataTemplate></GridViewColumn.CellTemplate></GridViewColumn>
                            <GridViewColumn Width="165"><GridViewColumn.Header><DockPanel><TextBlock Text="VRAM (Uncompressed)" Tag="EstimatedVramUncompressed"/><TextBlock Margin="5,0,0,0" Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=GridViewColumnHeader}}"><TextBlock.Style><Style TargetType="TextBlock"><Setter Property="Text" Value=""/><Style.Triggers><MultiDataTrigger><MultiDataTrigger.Conditions><Condition Binding="{Binding DataContext.CurrentSortColumn, RelativeSource={RelativeSource AncestorType=ListView}}" Value="EstimatedVramUncompressed"/><Condition Binding="{Binding DataContext.SortDirection, RelativeSource={RelativeSource AncestorType=ListView}}" Value="Ascending"/></MultiDataTrigger.Conditions><Setter Property="Text" Value="▲"/></MultiDataTrigger><MultiDataTrigger><MultiDataTrigger.Conditions><Condition Binding="{Binding DataContext.CurrentSortColumn, RelativeSource={RelativeSource AncestorType=ListView}}" Value="EstimatedVramUncompressed"/><Condition Binding="{Binding DataContext.SortDirection, RelativeSource={RelativeSource AncestorType=ListView}}" Value="Descending"/></MultiDataTrigger.Conditions><Setter Property="Text" Value="▼"/></MultiDataTrigger></Style.Triggers></Style></TextBlock.Style></TextBlock></DockPanel></GridViewColumn.Header><GridViewColumn.CellTemplate><DataTemplate><TextBlock HorizontalAlignment="Right"><TextBlock.Style><Style TargetType="TextBlock"><Setter Property="Text" Value="{Binding EstimatedVramUncompressed, Converter={StaticResource FileSizeConverter}}"/><Style.Triggers><DataTrigger Binding="{Binding HasConditionalContent}" Value="True"><Setter Property="ToolTip"><Setter.Value><ToolTip Style="{StaticResource RimworldToolTip}"><StackPanel><TextBlock Text="Conditional Content:" FontWeight="Bold" Margin="0,0,0,4"/><ItemsControl ItemsSource="{Binding ConditionalDependencies}"><ItemsControl.ItemTemplate><DataTemplate DataType="{x:Type tools:ConditionalDependency}"><StackPanel Orientation="Horizontal"><TextBlock Text="{Binding IsActive, Converter={StaticResource BooleanToTextConverter}, ConverterParameter='❌|✅'}" VerticalAlignment="Center" Margin="0,0,5,0"/><TextBlock Text="{Binding PackageId}" VerticalAlignment="Center"/></StackPanel></DataTemplate></ItemsControl.ItemTemplate></ItemsControl></StackPanel></ToolTip></Setter.Value></Setter></DataTrigger><DataTrigger Binding="{Binding DataContext.ShowMaxVram, RelativeSource={RelativeSource AncestorType=ListView}}" Value="True"><Setter Property="Text" Value="{Binding MaxEstimatedVramUncompressed, Converter={StaticResource FileSizeConverter}}"/><Setter Property="ToolTip" Value="Showing maximum possible usage."/></DataTrigger></Style.Triggers></Style></TextBlock.Style></TextBlock></DataTemplate></GridViewColumn.CellTemplate></GridViewColumn>
                        </GridView>
                    </ListView.View>
                </ListView>
            </Border>
        </Grid>
    </DockPanel>
</UserControl>